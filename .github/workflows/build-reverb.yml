name: "Build Reverb"

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
  AWS_DEFAULT_REGION: us-east-1
  R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
  R2_BUCKET: ${{ secrets.R2_BUCKET_NAME }}

jobs:
  check-version:
    name: "Check for new Reverb version"
    runs-on: ubuntu-latest
    outputs:
      new_version_available: ${{ steps.compare.outputs.new_version_available }}
      latest_version: ${{ steps.compare.outputs.latest_version }}
    steps:
      - name: "Checkout"
        uses: actions/checkout@v5

      - name: "Get current and latest versions"
        id: compare
        run: |
          # Current version from composer.json
          CURRENT=$(jq -r '.require["laravel/reverb"]' composer.json | sed 's/[\^~]//')

          # Latest GitHub release
          LATEST=$(curl -s https://api.github.com/repos/laravel/reverb/releases/latest | \
            jq -r '.tag_name' | \
            sed 's/^v//')

          echo "Current: $CURRENT"
          echo "Latest: $LATEST"

          if [ "$CURRENT" != "$LATEST" ]; then
            echo "new_version_available=true" >> $GITHUB_OUTPUT
          else
            echo "new_version_available=false" >> $GITHUB_OUTPUT
          fi
          echo "latest_version=$LATEST" >> $GITHUB_OUTPUT

  build-reverb:
    name: "Build and Deploy Reverb"
    needs: check-version
    if: |
      needs.check-version.outputs.new_version_available == 'true' ||
      github.event_name == 'workflow_dispatch'
    runs-on: macos-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: "Checkout"
        uses: actions/checkout@v5

      - name: "Setup PHP"
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.4

      - name: "Prepare environment"
        run: |
          cp .env.example .env

      - name: "Update composer.json with new version"
        if: needs.check-version.outputs.new_version_available == 'true'
        run: |
          NEW_VERSION="${{ needs.check-version.outputs.latest_version }}"
          jq --arg v "^$NEW_VERSION" '.require["laravel/reverb"] = $v' composer.json > tmp.json
          mv tmp.json composer.json
          echo "Updated laravel/reverb to ^$NEW_VERSION"

      - name: "Install dependencies"
        run: composer update --no-dev --optimize-autoloader

      - name: "Create PR"
        if: needs.check-version.outputs.new_version_available == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          NEW_VERSION="${{ needs.check-version.outputs.latest_version }}"
          BRANCH="chore/bump-reverb-$NEW_VERSION"

          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          git checkout -b "$BRANCH"
          git add composer.json composer.lock
          git commit -m "chore: bump laravel/reverb to $NEW_VERSION"
          git push -u origin "$BRANCH"

          PR_URL=$(gh pr create \
            --title "chore: bump laravel/reverb to $NEW_VERSION" \
            --body "Automated version bump for laravel/reverb to $NEW_VERSION" \
            --base main \
            --head "$BRANCH")

          echo "PR_URL=$PR_URL" >> $GITHUB_ENV

      - name: "Generate application key"
        run: php artisan key:generate

      - name: "Setup database"
        run: |
          touch database/database.sqlite
          php artisan migrate --force

      - name: "Extract Reverb version"
        id: version
        run: |
          VERSION=$(composer show laravel/reverb --format=json | jq -r '.versions[0]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Reverb version: $VERSION"

      - name: "Generate timestamp"
        id: timestamp
        run: |
          TIMESTAMP=$(date -u +"%Y%m%d%H%M%S")
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "Generated timestamp: $TIMESTAMP"

      - name: "Create archive"
        run: |
          TIMESTAMP="${{ steps.timestamp.outputs.timestamp }}"
          ARCHIVE_NAME="reverb-${TIMESTAMP}.tar.gz"

          # Archive everything except .git and .github
          tar -czf "$ARCHIVE_NAME" \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='tests' \
            --exclude='node_modules' \
            .

          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> $GITHUB_ENV
          echo "Created archive: $ARCHIVE_NAME ($(du -h "$ARCHIVE_NAME" | cut -f1))"

      - name: "Calculate SHA256"
        run: |
          SHA256=$(sha256sum "$ARCHIVE_NAME" | awk '{print $1}')
          echo "SHA256=$SHA256" >> $GITHUB_ENV
          echo "SHA256: $SHA256"

      - name: "Upload archive to R2"
        run: |
          aws s3 cp "$ARCHIVE_NAME" s3://$R2_BUCKET/"$ARCHIVE_NAME" --endpoint-url $R2_ENDPOINT
          echo "Uploaded $ARCHIVE_NAME to R2"

      - name: "Update metadata-reverb.json"
        run: |
          # Download existing metadata or create empty
          aws s3 cp s3://$R2_BUCKET/metadata-reverb.json metadata-reverb.json --endpoint-url $R2_ENDPOINT 2>/dev/null || echo '{}' > metadata-reverb.json

          # Update metadata with new version
          jq --arg version "${{ steps.version.outputs.version }}" \
             --arg sha256 "$SHA256" \
             --arg filename "$ARCHIVE_NAME" \
             '.reverb = {latest: $version, sha256: $sha256, filename: $filename}' \
             metadata-reverb.json > metadata-reverb.json.tmp && mv metadata-reverb.json.tmp metadata-reverb.json

          echo "Updated metadata-reverb.json:"
          cat metadata-reverb.json

      - name: "Upload metadata to R2"
        run: aws s3 cp metadata-reverb.json s3://$R2_BUCKET/metadata-reverb.json --endpoint-url $R2_ENDPOINT

      - name: "Cleanup old builds"
        run: |
          echo "Cleaning up old Reverb builds (keeping only current: $ARCHIVE_NAME)..."

          aws s3api list-objects-v2 \
            --bucket $R2_BUCKET \
            --prefix "reverb-" \
            --endpoint-url $R2_ENDPOINT \
            --query 'Contents[].Key' \
            --output text | tr '\t' '\n' | while read -r file_key; do

            if [[ "$file_key" =~ ^reverb-.*\.tar\.gz$ ]] && [[ "$file_key" != "$ARCHIVE_NAME" ]]; then
              echo "Deleting old build: $file_key"
              aws s3 rm s3://$R2_BUCKET/"$file_key" --endpoint-url $R2_ENDPOINT || true
            fi
          done

          echo "Cleanup completed"

      - name: "Enable auto-merge"
        if: needs.check-version.outputs.new_version_available == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh pr merge --auto --squash --delete-branch "$PR_URL"
